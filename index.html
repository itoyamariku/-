<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>検品アプリ</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body { font-family: sans-serif; padding: 10px; }
#reader { width: 100%; max-width: 400px; margin-top: 10px; }
.done { color: green; font-weight: bold; }
.ng { color: red; }
</style>
</head>
<body>

<h2>検品開始</h2>

出庫日：
<input type="date" id="shippingDate"><br><br>

積込担当者：
<select id="staff">
  <option value="">全員</option>
  <option value="幸地">幸地</option>
  <option value="小管">小管</option>
  <option value="大城">大城</option>
</select><br><br>

<button onclick="startCheck()">検品開始</button>

<hr>

<div id="status"></div>
<div id="count"></div>
<div id="reader"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzeJipYaPEqnBzmdDdSbNSf2GGoqeJSRVe-2e9UQ4BFO_bhxlstS5a23aLs2KBgCao2/exec";

fetch(GAS_URL)
  .then(res => res.json())
  .then(data => {
    masterData = data;
    console.log("マスタ取得完了", masterData);
  })
  .catch(err => {
    alert("マスタ取得に失敗しました");
  });

let masterData = [];


let targetData = [];
let locked = false;
let qr;
//文字列調整
function normalize(str) {
  return String(str)
    .replace(/\s+/g, "")
    .replace(/　/g, "")
    .trim();
}
// ===== 検品開始 =====
function startCheck() {
  const date = document.getElementById("shippingDate").value;
  const staff = document.getElementById("staff").value;

  targetData = masterData.filter(d =>
    d.date === date &&
    (staff === "" || d.staff === staff)
  );

  if (targetData.length === 0) {
    alert("対象データがありません");
    return;
  }

  document.getElementById("status").innerText = "検品中";
  updateCount();

  qr = new Html5Qrcode("reader");
  qr.start(
    { facingMode: "environment" },
{ fps: 3, qrbox: { width: 300, height: 300 } },
    onScan
  );
}

// ===== QR解析 =====
function parseQR(text) {
  // ① 前処理
  text = String(text)
    .replace(/[\[\]\r\n]/g, "")
    .trim();

  // ② カンマで分割
  const items = text.split(",");

  // ③ 出庫No.（空白区切りを連結）
  const outParts = items[0].trim().split(/\s+/);
  const outNo = outParts.join("");

  // ④ 伝票番号・行数
  const slipNo = items[1].trim();
  const row    = items[2].trim();

  // ⑤ フォーマット統一（念のため）
  return {
    outNo:  outNo,                 // 015222087
    slipNo: slipNo.padStart(2, "0"),// 01
    row:    row.padStart(2, "0")    // 01
  };
}

// ===== QR読み取り成功 =====
function onScan(text) {
console.log("QR", qrData);
console.log("MASTER", targetData);
  if (locked) return;

  const qrData = parseQR(text);

const target = targetData.find(d =>
  normalize(d.outNo) === normalize(qrData.outNo) &&
  normalize(d.slipNo) === normalize(qrData.slipNo) &&
  normalize(d.row) === normalize(qrData.row) &&
  d.status === "未検品"
  );

  if (!target) {
    document.getElementById("status").innerHTML =
      "<span class='ng'>対象外 or 検品済</span>";
    return;
  }

  target.status = "検品済";

fetch(`${GAS_URL}?outNo=${qrData.outNo}&slipNo=${qrData.slipNo}&row=${qrData.row}`);

  document.getElementById("status").innerHTML =
    "<span class='done'>OK</span>";

  updateCount();
}

// ===== 残件管理 =====
function updateCount() {
  const remain = targetData.filter(d => d.status === "未検品").length;
  document.getElementById("count").innerText = `残り ${remain} 件`;

  if (remain === 0) {
    locked = true;
    qr.stop();
    alert("検品完了");
  }
}
</script>

</body>
</html>
