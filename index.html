<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QR検品アプリ（テスト版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin-bottom: 10px;
    }
    .ok {
      color: green;
      font-weight: bold;
    }
    .ng {
      color: red;
      font-weight: bold;
    }
    pre {
      background: #f5f5f5;
      padding: 5px;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>

<body>
  <h2>QR検品アプリ（動作確認用）</h2>

  <div id="reader"></div>

  <div>
    <strong>QR読み取り結果（生データ）：</strong>
    <pre id="qrRaw">未読</pre>
  </div>

  <div>
    <strong>解析結果：</strong>
    <pre id="qrParsed">---</pre>
  </div>

  <div id="result"></div>

<script>
/* ===== 仮マスタデータ（後でGoogleスプレッドシートに置換） ===== */
const masterData = [
  {
    syukkoNo: "015222087",
    denpyoNo: "01",
    gyo: "01"
  }
];

/* ===== QR解析ロジック ===== */
function parseQR(qrText) {
  const clean = qrText.trim();          // 改行・空白除去
  const parts = clean.split(",");

  if (parts.length < 3) {
    return null;
  }

  // "01522 2 087" → "015222087"
  const syukkoNo = parts[0].split(" ").join("");

  return {
    syukkoNo: syukkoNo,
    denpyoNo: parts[1].trim(),
    gyo: parts[2].trim()
  };
}

/* ===== QR読み取り成功時 ===== */
function onScanSuccess(decodedText) {
  // 生データ表示
  document.getElementById("qrRaw").innerText = decodedText;

  const parsed = parseQR(decodedText);

  if (!parsed) {
    document.getElementById("qrParsed").innerText = "解析失敗";
    return;
  }

  // 解析結果表示
  document.getElementById("qrParsed").innerText =
    `出庫No.: ${parsed.syukkoNo}\n伝票番号: ${parsed.denpyoNo}\n行数: ${parsed.gyo}`;

  // マスタ照合
  const hit = masterData.some(m =>
    m.syukkoNo === parsed.syukkoNo &&
    m.denpyoNo === parsed.denpyoNo &&
    m.gyo === parsed.gyo
  );

  if (hit) {
    document.getElementById("result").innerHTML =
      `<p class="ok">✔ 検品OK</p>`;
  } else {
    document.getElementById("result").innerHTML =
      `<p class="ng">✖ 検品対象外</p>`;
  }
}

/* ===== カメラ起動 ===== */
const html5QrCode = new Html5Qrcode("reader");

html5QrCode.start(
  { facingMode: "environment" },
  {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    disableFlip: true
  },
  onScanSuccess,
  errorMessage => {
    // 読み取りエラーは無視（ログがうるさいため）
  }
);
</script>

</body>
</html>




