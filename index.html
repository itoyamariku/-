<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>検品アプリ</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body { font-family: sans-serif; padding: 10px; }
#reader { width: 100%; max-width: 400px; margin-top: 10px; }
.done { color: green; font-weight: bold; }
.ng { color: red; }
</style>
</head>
<body>

<h2>検品開始</h2>

出庫日：
<input type="date" id="shippingDate"><br><br>

積込担当者：
<select id="staff">
  <option value="">全員</option>
  <option value="山田">山田</option>
  <option value="佐藤">佐藤</option>
</select><br><br>

<button onclick="startCheck()">検品開始</button>

<hr>

<div id="status"></div>
<div id="count"></div>
<div id="reader"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwdEs68422Wp-EZ7uxrpAaJmtfZqZEjVEctPI_Ls2StrNww7vlCxhRY61h4Ce3p1vpi/exec";

fetch(GAS_URL)
  .then(res => res.json())
  .then(data => {
    masterData = data;
    console.log("マスタ取得完了", masterData);
  })
  .catch(err => {
    alert("マスタ取得に失敗しました");
  });

let masterData = [];


let targetData = [];
let locked = false;
let qr;

// ===== 検品開始 =====
function startCheck() {
  const date = document.getElementById("shippingDate").value;
  const staff = document.getElementById("staff").value;

  targetData = masterData.filter(d =>
    d.date === date &&
    (staff === "" || d.staff === staff)
  );

  if (targetData.length === 0) {
    alert("対象データがありません");
    return;
  }

  document.getElementById("status").innerText = "検品中";
  updateCount();

  qr = new Html5Qrcode("reader");
  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScan
  );
}

// ===== QR解析 =====
function parseQR(text) {
  const items = text.split(",");
  const [outNo, slipNo, row] = items[0].split(" ");
  return { outNo, slipNo, row };
}

// ===== QR読み取り成功 =====
function onScan(text) {
  if (locked) return;

  const qrData = parseQR(text);

  const target = targetData.find(d =>
    d.outNo === qrData.outNo &&
    d.slipNo === qrData.slipNo &&
    d.row === qrData.row &&
    d.status === "未検品"
  );

  if (!target) {
    document.getElementById("status").innerHTML =
      "<span class='ng'>対象外 or 検品済</span>";
    return;
  }

  target.status = "検品済";

fetch(`${GAS_URL}?outNo=${qrData.outNo}&slipNo=${qrData.slipNo}&row=${qrData.row}`);

  document.getElementById("status").innerHTML =
    "<span class='done'>OK</span>";

  updateCount();
}

// ===== 残件管理 =====
function updateCount() {
  const remain = targetData.filter(d => d.status === "未検品").length;
  document.getElementById("count").innerText = `残り ${remain} 件`;

  if (remain === 0) {
    locked = true;
    qr.stop();
    alert("検品完了");
  }
}
</script>

</body>
</html>



