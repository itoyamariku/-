<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>検品アプリ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: sans-serif; padding: 10px; }
#reader { width: 100%; max-width: 400px; margin-top: 10px; }
.done { color: green; font-weight: bold; }
.ng { color: red; font-weight: bold; }
.box { background: #f5f5f5; padding: 8px; margin-top: 8px; }
</style>
</head>

<body>

<h2>検品アプリ</h2>
<audio id="beep" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>

出庫日：
<input type="date" id="shippingDate"><br><br>

積込担当者：
<select id="staff">
  <option value="">全員</option>
  <option value="幸地1">幸地1</option>
    <option value="幸地2">幸地2</option>
  <option value="小管1">小管1</option>
    <option value="小管2">小管2</option>
  <option value="大城1">大城1</option>
    <option value="大城2">大城2</option>
</select><br><br>

<button onclick="startCheck()">検品開始</button>

<hr>

<div id="status"></div>
<div id="count"></div>
<div id="reader"></div>
<div id="qrDataView" class="box"></div>

<script>
/* ===== 設定 ===== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbwt8gb4cSvfhakkyLHZjk-vlthg21HRg1le7Quq2t4cqR2FwI8T50H_--NR1QqdrIBx/exec";

/* ===== 変数 ===== */
let masterData = [];
let targetData = [];
let locked = false;
let qr;

/* ===== マスタ取得 ===== */
fetch(GAS_URL)
  .then(res => res.json())
  .then(data => masterData = data)
  .catch(() => alert("マスタ取得に失敗しました"));

/* ===== 正規化 ===== */
function normalize(str) {
  return String(str).replace(/\s+/g, "").trim();
}
/* ===== 音 ===== */
  function beep() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.frequency.value = 1000; // ピッ
  gain.gain.value = 0.1;

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start();
  setTimeout(() => {
    osc.stop();
    ctx.close();
  }, 120);
}
/* ===== 検品開始 ===== */
function startCheck() {
  const date = document.getElementById("shippingDate").value;
  const staff = document.getElementById("staff").value;

  targetData = masterData.filter(d =>
    d.date === date &&
    (staff === "" || d.staff === staff)
  );

  if (targetData.length === 0) {
    alert("対象データがありません");
    return;
  }

  targetData.forEach(d => d.status = "未検品");

  document.getElementById("status").innerText = "検品中";
  updateCount();
  renderRemainList();

  qr = new Html5Qrcode("reader");
qr.start(
  { facingMode: "environment" },
  {
    fps: 30,
    qrbox: { width: 50, height: 50 },
    aspectRatio: 1.0,
    disableFlip: true
  },
  onScan
);
}

/* ===== QR解析 ===== */
function parseQR(text) {
  const parts = text.trim().split(",");
  if (parts.length < 4 || normalize(parts[0]) !== "SYU") return null;

  return {
    outNo: parts[1].replace(/\s/g, ""),
    slipNo: parts[2].padStart(2, "0"),
    row: parts[3].padStart(2, "0")
  };
}

/* ===== QR読取 ===== */
function onScan(text) {
  if (locked) return;

  const qrData = parseQR(text);
  if (!qrData) {
    document.getElementById("status").innerHTML =
      "<span class='ng'>QR形式エラー</span>";
    return;
  }

  const target = targetData.find(d =>
    normalize(d.outNo) === normalize(qrData.outNo) &&
    normalize(d.slipNo) === normalize(qrData.slipNo) &&
    normalize(d.row) === normalize(qrData.row) &&
    d.status === "未検品"
  );

  if (!target) {
    document.getElementById("status").innerHTML =
      "<span class='ng'>対象外 or 検品済</span>";
    return;
  }

  target.status = "検品済";
beep();

  document.getElementById("status").innerHTML =
    "<span class='done'>OK</span>";

  renderRemainList();
  updateCount();
}

/* ===== 未検品一覧 ===== */
function renderRemainList() {
  const remain = targetData.filter(d => d.status === "未検品");

  if (remain.length === 0) {
    document.getElementById("qrDataView").innerHTML =
      "<b>未読み取りはありません</b>";
    return;
  }

  let html = "<b>未読み取り一覧</b><br>";
  remain.forEach(d => {
    html += `
      【${d.destination}】<br>
      出庫No:${d.outNo} / 伝票:${d.slipNo} / 行:${d.row}<br><br>
    `;
  });

  document.getElementById("qrDataView").innerHTML = html;
}

/* ===== 残件管理 ===== */
function updateCount() {
  const remain = targetData.filter(d => d.status === "未検品").length;
  document.getElementById("count").innerText = `残り ${remain} 件`;

  if (remain === 0) {
    locked = true;
    qr.stop();
    alert("検品完了");
  }
}
</script>

</body>
</html>






















